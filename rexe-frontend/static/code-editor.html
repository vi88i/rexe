<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Vighnesh Nayak S">
  <meta name="description" content="remote code execution service">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <style type="text/css">
    #grid-container {
      display: grid;
      grid-template-columns: auto auto auto;
      grid-template-columns: auto auto auto;
      grid-gap: 1%;
      margin: auto;
      width: 95%;      
    }
    #code_div {
      grid-row: 1 / span 2;
      grid-column: 1 / span 2;
    }
    #input_div {
      grid-row: 1 / span 2;
      grid-column: 3; 
    }     
    #output_div {
      grid-row: 2;
      grid-column: 3; 
    }  
    #code {
      resize: none;
      white-space: pre-wrap;
      cursor: auto;
    }
    #input {
      resize: none;
      white-space: pre-wrap;
      cursor: auto;
    }
    #output {
      resize: none;
      white-space: pre-wrap;
      cursor: auto;
    }      
    #navbar {
      background-color: midnightblue;
      margin: auto;
      width: 50%;
      padding: 4px;
      display: flex;
      justify-content: space-between;
    }
  </style>
  <title>rexe</title>
</head>
<body>
  <div id="navbar">
    <span id="username"></span>
    <div>
      <button onclick="signOut()">Log out</button>
    </div>
  </div>   
  <div id="grid-container">
    <div id="code_div">     
      <p>
        <span>
          <select name="cars" id="lang">
            <option value="cpp">C++</option>
            <option value="py">Python</option>
          </select>          
          <input placeholder="filename" id="filename" type="text">
          <button id="load">Load</button>
          <button id="save">Save</button>
          <button id="run" onclick="run()">Run</button>
          <span id="info"></span>
        </span>
      </p>
      <textarea spellcheck="false" id="code" rows="40" cols="130" placeholder="write your code here"></textarea>
    </div>
    <div id="input_div">
      <p>
        <span>
          <input id="time_limit" type="text" placeholder="time limit:[2, 7] seconds">
          <input id="memory_limit" type="text" placeholder="memory limit:[32, 512] MB">
        </span>
      </p>
      <textarea spellcheck="false" id="input" rows="18" cols="80" placeholder="stdin"></textarea>
    </div>
    <div id="output_div">
      <p>
        <span id="execInfo"></span>
      </p>
      <textarea id="output" spellcheck="false" id="output" rows="18" cols="80" placeholder="stdout" readonly></textarea>
    </div>    
  </div> 
  <p style="margin-left: 3%;">Total size of code and test cases cannot exceed 256KB. Output is restricted to 500 KB.</p>
  <script type="text/javascript">
    function disableOps() {
      ['load', 'save', 'run'].forEach((e) => {
        document.getElementById(e).style.cursor = 'not-allowed';
        document.getElementById(e).disabled = true;
      });
    }

    function enableOps(poll) {
      ['load', 'save', 'run'].forEach((e) => {
        document.getElementById(e).style.cursor = 'auto';
        document.getElementById(e).disabled = false;
      });
      if (poll) {
        clearInterval(poll);
      }
    }

    async function signOut() {
      try {
        let options = {
          method: 'GET',
          mode: 'same-origin',
          cache: 'no-store',
          credentials: 'same-origin'
        };
        const res = await fetch('/sign-out', options);
        if (res.ok) {
          window.location.href = '/';
        }
      } catch(err) {
        console.log(err);
      }      
    }

    async function run() {
      const f = document.getElementById('filename');
      const c = document.getElementById('code');
      const t = document.getElementById('input');
      const l = document.getElementById('lang');
      const ti = document.getElementById('time_limit');
      const m = document.getElementById('memory_limit');

      disableOps();

      try {
        let options = {
          method: 'POST',
          mode: 'same-origin',
          cache: 'no-store',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            filename: f.value, 
            code: c.value, 
            input: t.value, 
            lang: l.value, 
            time_limit: ti.value, 
            memory_limit: m.value   
          })
        };
        const res = await fetch('/run', options);
        if ([200, 400, 429, 500].indexOf(res.status) !== -1) {
          const data = await res.json();
          document.getElementById('info').innerText = data.msg;
          if (data.status && data.status === 'pending') {
            let retry = 0;
            const poll = setInterval(async () => {
              // 150 * 2 = retention period
              if (retry === 150) {
                document.getElementById('info').innerText = 'Failed to process your previous submission';
                enableOps(poll);
              }
              try {
                const options = {
                  mode: 'same-origin',
                  cache: 'no-store',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ filename: f.value, lang: l.value })
                };
                const res = await fetch('/check', options);
                const json = await res.json();
                if (json.status === 'stop') {
                  document.getElementById('info').innerText = 'Submission timeout';
                  enableOps(poll);
                } else if (json.status !== 'pending') {
                  const info = [json.status, json.signal !== null ? json.signal : '', json.time !== null ? json.time.toFixed(1) + 'ms' : '', json.memory !== null ? json.memory.toFixed(1) + 'MB' : ''].join(' ').replace(/\s+/g,' ').trim();
                  document.getElementById('info').innerText = 'Finished';
                  document.getElementById('execInfo').innerHTML = info;
                  document.getElementById('output').innerHTML = json.output;
                  enableOps(poll);
                }
              } catch(err) {
                console.log(err);
              } finally {
                retry += 1;
              }
            }, 2000);
          } else {
            enableOps(null);
          }
        } else {
          window.location.href = '/';
        }
      } catch(err) {
        enableOps(null);
        console.log(err);
      }      
    }

    async function isLoggedIn() {
      try {
        let options = {
          method: 'GET',
          mode: 'same-origin',
          cache: 'no-store',
          credentials: 'same-origin'
        };
        const res = await fetch('/isLoggedIn', options);
        if (!res.ok) {
          window.location.href = '/';
        }
      } catch(err) {
        console.log(err);
      }
    }
    isLoggedIn()
      .then(() => {
        document.getElementById('username').innerText = document.cookie.split('=')[1];
      });
    // /* source: https://stackoverflow.com/questions/6637341/use-tab-to-indent-in-textarea */
    // function enableTab(e) {
    //   if (e.key == 'Tab') {
    //     e.preventDefault();
    //     let start = this.selectionStart;
    //     let end = this.selectionEnd;
    //     this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);
    //     this.selectionStart = this.selectionEnd = start + 1;
    //   }      
    // }
    // document.getElementById('code').addEventListener('keydown', enableTab(e));
    // document.getElementById('input').addEventListener('keydown', enableTab(e));
  </script> 
</body>
</html>
